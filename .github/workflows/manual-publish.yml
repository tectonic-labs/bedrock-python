name: Manual Publish

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run with --dry-run?"
        required: true
        type: boolean
        default: false

jobs:
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for trusted publishing
      contents: read

    steps:
      - name: Checkout selected tag
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref }}

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add GitHub to known hosts
        run: ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Sync pyproject.toml to Tag Name
        run: |
          RAW_TAG=${{ github.ref_name }}
          VERSION=$(echo "$RAW_TAG" | sed 's/^v//')
          echo "Syncing pyproject.toml version to: $VERSION"
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          grep "^version =" pyproject.toml

      - name: Dry run (build only)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        uses: PyO3/maturin-action@v1
        with:
          command: build
          before-script-linux: yum install -y clang-devel cmake3 && ln -sf /usr/bin/cmake3 /usr/bin/cmake || true

      - name: Build and publish
        if: ${{ github.event.inputs.dry_run != 'true' }}
        uses: PyO3/maturin-action@v1
        with:
          command: publish
          args: --skip-existing
          before-script-linux: yum install -y clang-devel cmake3 && ln -sf /usr/bin/cmake3 /usr/bin/cmake || true
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
